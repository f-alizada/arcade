on:
  workflow_call:
    inputs:      
      base_branch:
        type: string
        required: true
      allowAutomatedCommits:
        type: boolean
        required: false
        default: false
      quietComments:
        type: boolean
        required: false
        default: true
      
jobs:
  run-merge:
    runs-on: windows-latest
    permissions:
      contents: write
      pull-requests: write
    env: 
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: repository
          fetch-depth: 0
      - name: Checkout arcade repository
        uses: actions/checkout@v4
        with:
          repository: f-alizada/arcade # will be replaced with dotnet: dotnet/arcade
          path: arcade-repository 
          ref: release/8.0 # will be replaced with main

      - name: Print GitHub repo
        run: echo ${{ github.repository }}

      - name: Print GitHub ref name
        run: echo $env:GITHUB_REF_NAME

      - name: Switch parameters setting
        run: | 
          $mergeSwitchArguments = ""
          
          echo ${{ inputs.allowAutomatedCommits }}
          echo ${{ inputs.quietComments }}

          if ('${{ inputs.allowAutomatedCommits }}' -eq 'true') {
            $mergeSwitchArguments = "-AllowAutomatedCommits"
          }else{
            echo "allow automated commits is not allowed"
          }

          if ('${{ inputs.quietComments }}' -eq 'true') {
            $mergeSwitchArguments = $mergeSwitchArguments + " -QuietComments"
          }else{
            echo "QuietComments is not allowed"
          }

          echo $mergeSwitchArguments

      - name: Fetch repository name
        id: fetch-repo-name
        run: |
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Repository name: ${{ github.repository }}"
          $repoName = "${{ github.repository }}"
          $repoNameWithoutOwner = $repoName.Substring("${{ github.repository_owner }}".Length + 1)
          "repository_name=$repoNameWithoutOwner" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
      
      - run: ${{ github.workspace }}\arcade-repository\.github\workflows\scripts\inter-branch-merge.ps1 -RepoName ${{ steps.fetch-repo-name.outputs.repository_name }} -RepoOwner ${{ github.repository_owner }} -HeadBranch $env:GITHUB_REF_NAME -BaseBranch ${{ inputs.base_branch }}
        name: Merge branches
        working-directory: ${{ github.workspace }}/repository